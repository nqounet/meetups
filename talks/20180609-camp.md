# Booking System with Phoenix
##### Fiilse Hackathon 2018
##### Nobutaka Wakabayashi

---

# Motivation

- å¦»ã€Œäºˆç´„ã‚·ã‚¹ãƒ†ãƒ ä½œã£ã¦ã‚ˆã€
- ç§ã€Œã¯ã„ã€

---

# Phoenix

- Phoenix ã¯ Elixir ã§æ›¸ã‹ã‚ŒãŸ MVC ãƒ‘ã‚¿ãƒ¼ãƒ³ã® web é–‹ç™ºãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™

http://phoenixframework.org/

---

# Elixir

- Elixir ã¯å‹•çš„ã‹ã¤é–¢æ•°çš„ãªè¨€èªã§ã€ã‚¹ã‚±ãƒ¼ãƒ«ã—ã‚„ã™ãä¿å®ˆã—ã‚„ã™ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹ãŸã‚ã«ãƒ‡ã‚¶ã‚¤ãƒ³ã•ã‚Œã¦ã„ã¾ã™

https://elixir-lang.org/

___

## Elixir ã®ç‰¹å¾´

- ã‚¹ã‚±ãƒ¼ãƒ«ã—ã‚„ã™ã„
- è€éšœå®³æ€§ãŒé«˜ã„(ãƒ•ã‚©ãƒ¼ãƒ«ãƒˆãƒˆãƒ¬ãƒ©ãƒ³ãƒˆ)
- é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°
- æ‹¡å¼µã—ã‚„ã™ã„

https://elixirschool.com/jp/

___

ã ã„ãŸã„ãã‚“ãªæ„Ÿã˜

---

# DEMO

http://localhost:3000

___

ã ã„ãŸã„ãã‚“ãªæ„Ÿã˜

---

# è£ãƒ†ãƒ¼ãƒ ğŸ˜ˆ

___

æ™®æ®µä½¿ã‚ãªã„ã‚‚ã®ã¯ `brew install` ã—ãŸããªã„

___

docker ã§ãªã‚“ã¨ã‹ã§ãã‚‹ã®ã§ã¯ï¼Ÿ

___

## ã§ãã¾ã—ãŸ ğŸ˜‡

---

## ç”¨æ„ã™ã‚‹ã‚‚ã®

- docker-compose.yml
- Dockerfile

___

## docker-compose.yml
```yaml
version: "3.2"
services:
    db:
        image: postgres
        volumes:
            - ./var/postgres:/var/lib/postgresql/data
    webapp:
        build: .
        command: mix phx.server
        depends_on:
            - db
        volumes:
            - .:/app
        ports:
            - "3000:4000"
```

___

### point

- volumes ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠãŒä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ°¸ç¶šåŒ–ã™ã‚‹
- åˆå›èµ·å‹•æ™‚ã¯ webapp:command ãŒå¤±æ•—ã™ã‚‹ãŒæ°—ã«ã—ãªã„
- webapp:depends_on ãŒé‡è¦ã ã£ãŸï¼ˆæ°—ãŒã™ã‚‹ï¼‰

___

## Dockerfile
```text
FROM elixir

RUN mix local.hex --force \
    && mix local.rebar --force \
    && mix archive.install https://github.com/phoenixframework/archives/raw/master/phx_new.ez --force

# nodeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN curl -sL https://deb.nodesource.com/setup_8.x | bash -
RUN apt-get install -y -q nodejs

WORKDIR /app
```

___

### point

- webapp ã«ã¯è¨€èªã®é–‹ç™ºç’°å¢ƒã‚’å…¥ã‚Œã‚‹

___

## ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œ

```shell
docker-compose build
docker-compose run webapp bash
```

- docker-compose ã§èµ·å‹•ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚‹

___

## ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã§å®Ÿè¡Œ

```shell
mix phx.new booking
```

- `mix` ã¯ elixir ãŒå…¥ã£ã¦ã„ã‚‹ã¨ä½¿ç”¨ã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰
- `phx.new` ã¯ Phoenix ãŒå…¥ã£ã¦ã„ã‚‹ã¨ä½¿ç”¨ã§ãã‚‹ `mix` ã®ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰

___

## ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã§ scaffold ãŒå®Ÿè¡Œã§ãã‚‹ï¼

___

## DB ã¨ã®é€£æº

```elixir
# Configure your database
config :booking, Booking.Repo,
  adapter: Ecto.Adapters.Postgres,
  username: "postgres",
  password: "postgres",
  database: "booking_dev",
  hostname: "db",
  pool_size: 10
```

- hostname ã‚’ localhost ã‹ã‚‰ db ã«å¤‰æ›´ã™ã‚‹

___

## ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã§å®Ÿè¡Œ

```shell
cd booking
mix ecto.create
```

- ecto ã¯ DB ã‚’ä½¿ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- DB ã«æ¥ç¶šã—ã¦åˆæœŸåŒ–ã™ã‚‹

___

## ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ãˆã° Postgres ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãªãã¦ã„ã„ï¼

- postgres ã¯ docker ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒãã®ã¾ã¾ä½¿ãˆã‚‹
- https://hub.docker.com/_/postgres/

___

ã ã„ãŸã„ãã‚“ãªæ„Ÿã˜

---

## ã¡ã‚‡ã£ã¨ã—ãŸã“ã ã‚ã‚Š

___

scaffold ã™ã‚‹ã¨ã€å¤§æŠµã®å ´åˆã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã§ãã‚‹

```
mix phx.new booking
tree -L 2
.
â”œâ”€â”€ booking
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ _build
â”‚Â Â  â”œâ”€â”€ assets
â”‚Â Â  â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ deps
â”‚Â Â  â”œâ”€â”€ lib
â”‚Â Â  â”œâ”€â”€ mix.exs
â”‚Â Â  â”œâ”€â”€ mix.lock
â”‚Â Â  â”œâ”€â”€ priv
â”‚Â Â  â””â”€â”€ test
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ readme.md
â”œâ”€â”€ script
â””â”€â”€ var
    â””â”€â”€ postgres
```

___

scaffold ã—ãŸã‚ã¨ã« docker-compose.yml ã‚’æ›¸ãæ›ãˆã‚‹

```
    webapp:
        build: booking
        command: mix phx.server
        depends_on:
            - db
        volumes:
            - ./booking:/app
        ports:
            - "3000:4000"
```

___

Dockerfile ã‚‚ç§»å‹•ã™ã‚‹

```shell
mv Dockerfile booking
```

- docker-compose ã§ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠæ¯ã« build å¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã§ãã‚‹
- ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®ã‚³ãƒ³ãƒ†ãƒŠã¯ç‹¬ç«‹ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å­˜åœ¨ã—ãŸã»ã†ãŒè‰¯ã„

___

ã ã„ãŸã„ãã‚“ãªæ„Ÿã˜

---

# Questions?

---

# Thanks!
https://twitter.com/nqounet
